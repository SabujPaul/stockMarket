<html>
<head>
    <title>Stock Data</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas {
            max-width: 800px;
        }
    </style>
</head>
<body>
    <h1>Stock Data</h1>

    <!-- Line chart and dropdown for trade_code selection -->
    <div>
        <label for="tradeCodeDropdown">Select Trade Code:</label>
        <select id="tradeCodeDropdown" onchange="updateChartData()">
            <option value="all">All Trade Codes</option>
            <!-- Add options dynamically based on available trade codes -->
            {% for trade_code in trade_codes %}
                <option value="{{ trade_code }}">{{ trade_code }}</option>
            {% endfor %}
        </select>
    </div>

    <div>
        <canvas id="lineChart"></canvas>
    </div>

    <table>
        <!-- ... table code ... -->
    </table>

    <a href="{% url 'stock_create' %}">Add Stock</a>

    <script>
        var stocksData = JSON.parse('{{ stocks_json|escapejs }}');
        var chartData = [];
        var labels = [];

        function filterStocksByTradeCode(tradeCode) {
            if (tradeCode === 'all') {
                return stocksData;
            } else {
                return stocksData.filter(function (stock) {
                    return stock.trade_code === tradeCode;
                });
            }
        }

        function updateChartData() {
            var selectedTradeCode = document.getElementById('tradeCodeDropdown').value;
            var filteredStocks = filterStocksByTradeCode(selectedTradeCode);

            // Extract labels and data for the line chart
            labels = filteredStocks.map(function (stock) {
                return stock.date;
            });

            chartData = filteredStocks.map(function (stock) {
                return stock.close;
            });

            updateChart();
        }

        function updateChart() {
            var ctx = document.getElementById('lineChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Close Prices',
                        data: chartData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: [{
                            type: 'linear',
                            position: 'bottom'
                        }]
                    }
                }
            });
        }

        // Initial call to set up the chart
        updateChartData();
    </script>
</body>
</html>